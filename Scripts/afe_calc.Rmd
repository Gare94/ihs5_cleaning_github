---
title: "AFE Metric Calculation"
author: "Gareth Osman"
date: "2025-06-13"
output: html_document
---

```{r}
#Packages 
library(haven)
library(tidyverse)

```

#Household roster 

```{r}

roster <- read_dta(here::here('HH_MOD_B.dta'))
ihs5.health <- read_dta(here::here('HH_MOD_D.dta'))

```

```{r}

roster <- roster %>% 
  rename('sex' = 'hh_b03',     #sex
         'age' = 'hh_b05a',  #age in years
         'age_months' = 'hh_b05b',  #age in months
         'r.head' = 'hh_b04',  #r/ship to household head
         'mother' = 'hh_b19a', #where is the [name's] mother
         'id.mother' = 'hh_b19b')  %>% #if household member, copy id 
  select(case_id, HHID, PID, sex, age, age_months, r.head, mother, id.mother)

roster <- roster %>% 
  mutate(age.m.total = age * 12 + ifelse(is.na(age_months), 0, age_months))

roster <- roster %>% mutate(age.u2 = case_when(age.m.total < 24 ~ "TRUE")) 

```

#For children under 2, subtract energy assumed to be provided via breastmilk to isolate just energy requirements from complementary foods

```{r}

roster$kcal <- NA  # Initialize kcal with NA

roster$kcal[roster$age.m.total < 3] <- 0  #assume exclusively breastfed
roster$kcal[roster$age.m.total == 3 & roster$sex == 1] <- 569 - 474
roster$kcal[roster$age.m.total == 4 & roster$sex == 1] <- 608 - 474
roster$kcal[roster$age.m.total == 5 & roster$sex == 1] <- 639 - 474
roster$kcal[roster$age.m.total == 6 & roster$sex == 1] <- 653 - 413
roster$kcal[roster$age.m.total == 7 & roster$sex == 1] <- 680 - 413
roster$kcal[roster$age.m.total == 8 & roster$sex == 1] <- 702 - 413
roster$kcal[roster$age.m.total == 9 & roster$sex == 1] <- 731 - 379
roster$kcal[roster$age.m.total == 10 & roster$sex == 1] <- 752 - 379
roster$kcal[roster$age.m.total == 11 & roster$sex == 1] <- 775 - 379
roster$kcal[roster$age.m.total >= 12 & roster$age.m.total < 24 & roster$sex == 1] <- 948 #/for child 12-24 months, subtract in random subset of children assumed to be breastfeeding according to DHS -- doing this separately with breastfeeding women

roster$kcal <- ifelse(roster$age.m.total < 3, 0, roster$kcal) #assume exclusively breastfed
roster$kcal[roster$age.m.total == 3 & roster$sex == 2] <- 537 - 474
roster$kcal[roster$age.m.total == 4 & roster$sex == 2] <- 571 - 474
roster$kcal[roster$age.m.total == 5 & roster$sex == 2] <- 599 - 474
roster$kcal[roster$age.m.total == 6 & roster$sex == 2] <- 604 - 413
roster$kcal[roster$age.m.total == 7 & roster$sex == 2] <- 629 - 413
roster$kcal[roster$age.m.total == 8 & roster$sex == 2] <- 652 - 413
roster$kcal[roster$age.m.total == 9 & roster$sex == 2] <- 676 - 379
roster$kcal[roster$age.m.total == 10 & roster$sex == 2] <- 694 - 379
roster$kcal[roster$age.m.total == 11 & roster$sex == 2] <- 712 - 379
roster$kcal[roster$age.m.total >= 12 & roster$age.m.total < 24 & roster$sex == 2] <- 865 #/for child 12-24 months, subtract in random subset of children assumed to be breastfeeding according to DHS -- doing this separately with breastfeeding women


roster$kcal[roster$age.m.total >= 24 & roster$age.m.total < 36 & roster$sex == 1] <- 1125
roster$kcal[roster$age.m.total >= 24 & roster$age.m.total < 36 & roster$sex == 2] <- 1050
roster$kcal[roster$age.m.total >= 36 & roster$age.m.total < 48 & roster$sex == 1] <- 1250
roster$kcal[roster$age.m.total >= 36 & roster$age.m.total < 48 & roster$sex == 2] <- 1150
roster$kcal[roster$age.m.total >= 48 & roster$age.m.total < 60 & roster$sex == 1] <- 1350
roster$kcal[roster$age.m.total >= 48 & roster$age.m.total < 60 & roster$sex == 2] <- 1250

roster$kcal[roster$age == 5 & roster$sex == 1] <- 1475
roster$kcal[roster$age == 5 & roster$sex == 2] <- 1335
roster$kcal[roster$age == 6 & roster$sex == 1] <- 1575
roster$kcal[roster$age == 6 & roster$sex == 2] <- 1425
roster$kcal[roster$age == 7 & roster$sex == 1] <- 1700
roster$kcal[roster$age == 7 & roster$sex == 2] <- 1550
roster$kcal[roster$age == 8 & roster$sex == 1] <- 1825
roster$kcal[roster$age == 8 & roster$sex == 2] <- 1700
roster$kcal[roster$age == 9 & roster$sex == 1] <- 1975
roster$kcal[roster$age == 9 & roster$sex == 2] <- 1850
roster$kcal[roster$age == 10 & roster$sex == 1] <- 2150
roster$kcal[roster$age == 10 & roster$sex == 2] <- 2000
roster$kcal[roster$age == 11 & roster$sex == 1] <- 2350
roster$kcal[roster$age == 11 & roster$sex == 2] <- 2150
roster$kcal[roster$age == 12 & roster$sex == 1] <- 2550
roster$kcal[roster$age == 12 & roster$sex == 2] <- 2275
roster$kcal[roster$age == 13 & roster$sex == 1] <- 2775
roster$kcal[roster$age == 13 & roster$sex == 2] <- 2375
roster$kcal[roster$age == 14 & roster$sex == 1] <- 3000
roster$kcal[roster$age == 14 & roster$sex == 2] <- 2450
roster$kcal[roster$age == 15 & roster$sex == 1] <- 3175
roster$kcal[roster$age == 15 & roster$sex == 2] <- 2500
roster$kcal[roster$age == 16 & roster$sex == 1] <- 3325
roster$kcal[roster$age == 16 & roster$sex == 2] <- 2500
roster$kcal[roster$age == 17 & roster$sex == 1] <- 3400
roster$kcal[roster$age == 17 & roster$sex == 2] <- 2500
roster$kcal[roster$age >= 18 & roster$age < 30 & roster$sex == 1] <- 2800 #Malawi NCD study 
roster$kcal[roster$age >= 18 & roster$age < 30 & roster$sex == 2] <- 2300 #2015/16 Malawi DHS
roster$kcal[roster$age >= 30 & roster$age < 60 & roster$sex == 1] <- 2850 #Malawi NCD study
roster$kcal[roster$age >= 30 & roster$age < 60 & roster$sex == 2] <- 2400 #Malawi NCD study
roster$kcal[roster$age >= 60 & roster$sex == 1] <- 2250 #Malawi NCD study
roster$kcal[roster$age >= 60 & roster$sex == 2] <- 2100 #Malawi NCD study

```

#*If there is a child under 2 in the household, assume there is a lactating women who requires 330 additional kcal/d if child is under 6 mo and 400 kcal/d if child is over 6 mo (https://www.dietaryguidelines.gov/)

```{r}

set.seed(54321)

# Step 1: Identify children under 2
roster <- roster %>%
  mutate(
    childu2 = ifelse(age.m.total < 24, 1, 0)
  )

# Step 2: Precompute random values
n <- nrow(roster)
rand_12_17 <- as.integer(rbinom(n, 1, 0.91)) #91% breastfed- 2015/16 MDHS 
rand_18_23 <- as.integer(rbinom(n, 1, 0.77)) #77% breastfed- 2015/16 MDHS

# Step 3: Assign breastfeeding status using consistent integer types
roster$breastfeeding_child <- if_else(
  roster$age.m.total < 12, 1L,
  if_else(
    roster$age.m.total >= 12 & roster$age.m.total < 18, rand_12_17,
    if_else(
      roster$age.m.total >= 18 & roster$age.m.total < 24, rand_18_23,
      0L
    )
  )
)

# Step 4: Household-level breastfeeding context
roster <- roster %>%
  group_by(HHID) %>%
  mutate(
    numberchildu2 = sum(childu2 == 1, na.rm = TRUE),
    age_youngest_child_months = ifelse(
      numberchildu2 > 0,
      min(age.m.total[childu2 == 1], na.rm = TRUE),
      NA_real_
    )
  ) %>%
  ungroup()

# Ensure PID and id.mother are character
roster <- roster %>%
  mutate(
    PID = as.character(PID),
    id.mother = as.character(id.mother)
  )

# Step 5: Filter and assign kcal per breastfeeding child
bf_children <- roster %>%
  filter(breastfeeding_child == 1, !is.na(id.mother)) %>%
  mutate(
    lact_kcal = case_when(
      age.m.total < 6 ~ 330,
      age.m.total >= 6 & age.m.total < 24 ~ 400,
      TRUE ~ NA_real_
    )
  )

# Step 6: Aggregate kcal per mother (take max kcal if multiple children)
mother_kcal <- bf_children %>%
  group_by(HHID, id.mother) %>%
  summarise(hh.lact = max(lact_kcal, na.rm = TRUE), .groups = "drop")

# Step 7: Join back to roster
roster <- roster %>%
  left_join(mother_kcal, by = c("HHID", "PID" = "id.mother"))

# Step 8: Subtract kcal from breastfeeding children aged 12â€“23 months
roster <- roster %>%
  mutate(
    kcal = ifelse(
      breastfeeding_child == 1 & age.m.total >= 12 & age.m.total < 24,
      kcal - 346,
      kcal
    )
  )

```

#Extra energy requirements for pregnancy

```{r}

#Illness
ihs5.preg <- ihs5.health %>% 
  rename('ill1' = 'hh_d05a',
         'ill2' = 'hh_d05b') %>% 
  filter(ill1==28 | ill2==28) %>% 
  select(case_id, HHID, PID, ill1, ill2)

roster$hh.preg <- NA

for(i in 1:nrow(ihs5.preg)){ #loop through breastfeeding children
  relevant_PID <- ihs5.preg$PID[i] #pull out data to identify mother
  relevant_HHID <- ihs5.preg$HHID[i] #pull out data to identify mother
  roster[roster$HHID == relevant_HHID & roster$PID == relevant_PID,]$hh.preg <- 300 #assign pregnant woman extra energy of 300
}

```

#Sum the energy requirements 

```{r}
roster$total_kcal <- rowSums(roster[, c("kcal", "hh.lact", "hh.preg")], na.rm = TRUE)

```

#Assumed energy requirements of adult female age 18-29
#Based on average weight of 54.5 kgs in 2015/16 DHS data and assuming PAL based on 1.75 X BMR

```{r}

roster <- roster %>%
  mutate(energy_req_afe = 2300)

```

#Calculate AFE weights based on energy requirements relative to adult female

```{r}

roster <- roster %>%
  mutate(afe = NA) %>%  # Create a new column 'afe' with NA values
  mutate(afe = total_kcal / energy_req_afe)  # Replace 'afe' with the calculated values


```

#Total household AFEs

```{r}

roster <- roster %>%
  group_by(HHID) %>%
  mutate(hhafe = sum(afe, na.rm = TRUE),  # Calculate total 'afe' for each 'household'
         hhmembers = n(),  # Count the number of members in each household
         obs = row_number()) %>% #Create a sequential number within each group
  filter(obs == 1)  # Keep only the first observation in each group


roster <- roster %>%
  select(HHID, hhafe, hhmembers)

```

#Fix single household factors

```{r}

roster <- roster %>% mutate(hhafe = case_when(hhmembers == 1 ~ 1, hhmembers != 1 ~ hhafe))

```

#Archive

```{r}

write.csv(roster, here::here('afe_ihs5.csv'), row.names = FALSE)

```
