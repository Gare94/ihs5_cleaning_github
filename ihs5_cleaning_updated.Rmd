---
title: "ihs5_cleaning2"
author: "Gareth Osman"
date: "5/11/2021"
output: html_document
---

INTRO 

1) We need to identify where the data on household consumption is stored. 

For ihs5, the data on food consumption was recorded as part of the household questionnaire (datasets starting w/ HH_). Within this questionnaire, data on food consumption is recorded in the module G (Food consumption). Within the module G, we find 3 sets of data, each one with different level of aggregation. We are interested in g1 which is food recorded at food item level (disaggregated data). 

Hence, we need to load the file hh_mod_g1 (household questionaire module G, 1- consumption at item level). Once it is loaded, we can check that the file is loaded correctly by checking that the observations (cases) and variables match the one reported in the worldbank website (https://microdata.worldbank.org/index.php/catalog/3818)

```{r}
#--- Load libraries 
library(plyr)
library(haven)
library(magrittr)
library(foreign)
library(psych)
library(readxl)
library(labelled)
library(tidyverse)

#--- Change to show no scientific notation & round to 3 decimal places
options(scipen = 10, digits=3) 

#--- Read in the files
ihs5 <- haven::read_dta("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/HH_MOD_G1.dta")
hhfilt <- haven::read_dta("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/hh_mod_a_filt.dta")
convf <- haven::read_dta("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/ihs_foodconversion_factor_2020.dta")

```

>CHANGE VARIABLE NAMES AND DATA CLASS 

The next step, the variables must then be standardized. This is important because we will be using data from various countries, and the variable names will vary from questionnaire to questionnaire. However, if we want to standardize (or harmonize) our cleaning and processing structure, it is best to standardize variable names (when possible). Within the data dictionary we can find a description of each variable. And, below is the codebook with the new variable names.

Variable category description: (i) hh_g03 refer to total consumption 
                               (ii) hh_g04 refers to purchased by the household 
                               (iii) hh_06 refers to food from own-production 
                               (iv) hh_g07 refers to food consumed from gift (and                                         other sources). 

Then, to identify variables that report quantity will be those that has an 'a' after the number (i.e. hh_g03a), variables reporting units will be identified by 'b' (i.e. hh_g07b, or hhg07b_label, hg07b_oth) and 'c' is for sub-unit related to photo aid guidance. 

Codebook (https://microdata.worldbank.org/index.php/catalog/3818/data-dictionary)

**Variable names need to be corrected!!** gift and purchased have the same code


```{r}

#--- Renaming variables to standard names 

#Summary info 
 ihs5 <- ihs5 %>% rename(
      id = 'case_id',
      consYN = 'hh_g01',
      item_code = 'hh_g02',
      item_oth = 'hh_g01_oth')


ihs5$id <- as.character(ihs5$id)
ihs5$consYN <- as.factor(ihs5$consYN)
ihs5$item_name <- as.factor(ihs5$item_code)
ihs5$item_oth <- as.factor(ihs5$item_oth)


#G03: Quantity and units consumed of each food 
ihs5 <- ihs5 %>% rename(
      cons_quant = 'hh_g03a',
      cons_unitA = 'hh_g03b',
      cons_unit = 'hh_g03b_label',
      cons_unit_oth = 'hh_g03b_oth',
      cons_unit_size = 'hh_g03c')

ihs5$cons_quant <- as.numeric(ihs5$cons_quant)
ihs5$cons_unitA <- as.factor(ihs5$cons_unitA)
ihs5$cons_unit <- as.factor(ihs5$cons_unit)
ihs5$cons_unit_oth <- as.factor(ihs5$cons_unit_oth)
ihs5$cons_unit_size <- as.factor(ihs5$cons_unit_size)


#G04: Quantity and units purchased of each food 
ihs5 <- ihs5 %>% rename(
      purc_quant = 'hh_g04a',
      purc_unitA = 'hh_g04b',
      purc_unit = 'hh_g04b_label',
      purc_unit_oth = 'hh_g04b_oth',
      purc_unit_size = 'hh_g04c',
      purc_price = 'hh_g05')

ihs5$purc_quant <- as.numeric(ihs5$purc_quant)
ihs5$purc_unitA <- as.factor(ihs5$purc_unitA)
ihs5$purc_unit <- as.factor(ihs5$purc_unit)
ihs5$purc_unit_oth <- as.factor(ihs5$purc_unit_oth)
ihs5$purc_unit_size <- as.factor(ihs5$purc_unit_size)
ihs5$purc_price <- as.numeric(ihs5$purc_price)

#G06: Quantity and units home produced of each food
ihs5 <- ihs5 %>% rename(
      prod_quant = 'hh_g06a',
      prod_unitA = 'hh_g06b',
      prod_unit = 'hh_g06b_label',
      prod_unit_oth = 'hh_g06b_oth',
      prod_unit_size = 'hh_g06c')

ihs5$prod_quant <- as.numeric(ihs5$prod_quant)
ihs5$prod_unitA <- as.factor(ihs5$prod_unitA)
ihs5$prod_unit <- as.factor(ihs5$prod_unit)
ihs5$prod_unit_oth <-as.factor(ihs5$prod_unit_oth)
ihs5$prod_unit_size <- as.factor(ihs5$prod_unit_size)

#G07: Quantity and units gifted/other source of each food 
ihs5 <- ihs5 %>% rename(
      gift_quant = 'hh_g07a',
      gift_unitA = 'hh_g07b',
      gift_unit = 'hh_g07b_label',
      gift_unit_oth = 'hh_g07b_oth',
      gift_unit_size = 'hh_g07c')

ihs5$gift_quant <- as.numeric(ihs5$gift_quant)
ihs5$gift_unitA <- as.factor(ihs5$gift_unitA)
ihs5$gift_unit <- as.factor(ihs5$gift_unit)
ihs5$gift_unit_oth <- as.factor(ihs5$gift_unit_oth)
ihs5$gift_unit_size <- as.factor(ihs5$gift_unit_size)

#Removing a duplicate variable- item_code
 ihs5 <- select(ihs5, -33)
 
```

>EXTRACTING VALUES AND LABELS OF LABELED 'ITEM_CODE'

The ihs5 dataset has stored the variable 'item_code' as a label (dbl+lbl). Hence we need to extract a two column data frame of value and label. The label and values are stored as an attribute of data frame. 

```{r}
ihs5 %>% distinct(item_code)

ihs5_attr <- stack(attr(ihs5$item_code, 'labels')) 

#Changing variable class
ihs5_attr$values <- as.factor(ihs5_attr$values)
ihs5$item_code <- as.factor(ihs5$item_code)

#Merging the values and labels back into the ihs5 dataset
ihs5 %>% 
    left_join(., ihs5_attr, by=c("item_code" = "values"))
ihs5 <- ihs5 %>% 
     left_join(., ihs5_attr, by=c("item_code" = "values"))

ihs5 <- ihs5 %>% relocate("ind", .after = item_code)
ihs5 <- ihs5 %>% rename(item_name_original = 'ind')

ihs5 <- ihs5 %>% arrange(cons_unit) %>% arrange(item_code) %>% arrange(HHID)
ihs5 <- ihs5 %>% select(id:consYN, item_code, item_name_original, item_oth:cons_unitA, cons_unit, cons_unit_oth:gift_unit_size)

```

>CLEANING UNITS LABELED AS 'OTHER'

Food items and units are coming from a standard list. However, some food consumed by the household is not in that list of items, hence it can be recorded under 'other'. The code to identify 'other food items varies depending on the food group

Similarly, for units, when the household is reporting the food consumed in a unit that it is not in the list will be recoded and the unit code apply for 'other' is 23.

There are a number of item units recorded as "23" but described as existing ucodes in our codebook.
We need to change these units from "23" to their appropriate units as in this analysis any item without a standard unit will be excluded. 

```{r}
ihs5 %>% filter(cons_unitA==23)

ihs5 %>% filter(cons_unit_oth!= "") %>% count(cons_unit_oth) %>% arrange(desc(n)) %>% print(n = nrow(ihs5))

#units listed as "other" and have not been converted to standard units
ihs5 %>% filter(cons_unitA==23) %>% count(cons_unit_oth) %>% arrange(desc(n)) %>% print(n = nrow(ihs5))

ihs5 %>% filter(., cons_unit_oth=="HEAP") %>% select(item_name_original, item_code, cons_quant, cons_unitA, cons_unit, cons_unit_oth) %>% arrange(item_name_original) %>% print(n = nrow(ihs5))

ihs5 %>% filter(item_code=="803") %>% select(item_name_original, item_code, cons_quant, cons_unitA, cons_unit, cons_unit_oth) %>% arrange(desc(cons_unitA))  %>% print(n = nrow(ihs5))

```

```{r}

#Cleaning top 15 known units labeled as 'Other'
ihs5[ihs5$cons_unit_oth == "PACKET", "cons_unitA"] <- "60"
ihs5[ihs5$cons_unit_oth == "SATCHET", "cons_unitA"] <- "22"
ihs5[ihs5$cons_unit_oth == "BASIN", "cons_unitA"] <- "27D"
ihs5[ihs5$cons_unit_oth == "PACKET UNSPECIFIED", "cons_unitA"] <- "51"
ihs5[ihs5$cons_unit_oth == "PLATE", "cons_unitA"] <- "6B"
ihs5[ihs5$cons_unit_oth == "TINA", "cons_unitA"] <- "25"
ihs5[ihs5$cons_unit_oth == "GRAMS", "cons_unitA"] <- "18"
ihs5[ihs5$cons_unit_oth == "PACKET (SMALL)", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "PIECE", "cons_unitA"] <- "9"
ihs5[ihs5$cons_unit_oth == "MILLILITRE", "cons_unitA"] <- "19"
ihs5[ihs5$cons_unit_oth == "PAIL (SMALL)", "cons_unitA"] <- "4A"
ihs5[ihs5$cons_unit_oth == "5L BUCKET", "cons_unitA"] <- "26"
ihs5[ihs5$cons_unit_oth == "HEAP", "cons_unitA"] <- "10"
ihs5[ihs5$cons_unit_oth == "BOTTLE (SMALL)" & ihs5$item_code == "803", "cons_unitA"] <- "15"

#Bunch- 8 doesn't exist in the standard unit list, but it does in the conversion factor file. Hence we store it. 
ihs5$cons_unitA <- as.character(ihs5$cons_unitA) 
ihs5[ihs5$cons_unit_oth == "BUNCH", "cons_unitA"] <- "8"
ihs5$cons_unitA <- as.factor(ihs5$cons_unitA)


#Cleaning other known units labeled as 'Other'
ihs5[ihs5$cons_unit_oth == "BATCHES", "cons_unitA"] <- "8"
ihs5[ihs5$cons_unit_oth == "BUNDLE", "cons_unitA"] <- "8"
ihs5[ihs5$cons_unit_oth == "TABLE SPOON", "cons_unitA"] <- "59"
ihs5[ihs5$cons_unit_oth == "PAIL", "cons_unitA"] <- "4"
ihs5[ihs5$cons_unit_oth == "KILOGRAM", "cons_unitA"] <- "1"
ihs5[ihs5$cons_unit_oth == "PAIL (LARGE)", "cons_unitA"] <- "4C"
ihs5[ihs5$cons_unit_oth == "SMALL PACKET", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "PAIL (MEDIUM)", "cons_unitA"] <- "4B"
ihs5[ihs5$cons_unit_oth == "LITRE", "cons_unitA"] <- "15"
ihs5[ihs5$cons_unit_oth == "TINA FLAT", "cons_unitA"] <- "25A"
ihs5[ihs5$cons_unit_oth == "MANGO", "cons_unitA"] <- "9"
ihs5[ihs5$cons_unit_oth == "SATCHET (SMALL)", "cons_unitA"] <- "22A"
ihs5[ihs5$cons_unit_oth == "TINA HEAPED", "cons_unitA"] <- "25B"
ihs5[ihs5$cons_unit_oth == "SMALL SACHET", "cons_unitA"] <- "22A"
ihs5[ihs5$cons_unit_oth == "CLUSTER", "cons_unitA"] <- "44"
ihs5[ihs5$cons_unit_oth == "PACKET LARGE", "cons_unitA"] <- "55"
ihs5[ihs5$cons_unit_oth == "SMALL HEAP", "cons_unitA"] <- "10A"
ihs5[ihs5$cons_unit_oth == "LARGE HEAP", "cons_unitA"] <- "10C"
ihs5[ihs5$cons_unit_oth == "SMALL TIN", "cons_unitA"] <- "71"
ihs5[ihs5$cons_unit_oth == "MEDIUM SACHET", "cons_unitA"] <- "22B"
ihs5[ihs5$cons_unit_oth == "SMALL  PACKET", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL TINA FLAT", "cons_unitA"] <- "25A"
ihs5[ihs5$cons_unit_oth == "1000G PACKET", "cons_unitA"] <- "37"
ihs5[ihs5$cons_unit_oth == "25 GRAM SATCHET", "cons_unitA"] <- "41"
ihs5[ihs5$cons_unit_oth == "BUNCH SMALL", "cons_unitA"] <- "8A"
ihs5[ihs5$cons_unit_oth == "G", "cons_unitA"] <- "18"
ihs5[ihs5$cons_unit_oth == "HEAP TINA", "cons_unitA"] <- "25B"
ihs5[ihs5$cons_unit_oth == "HEAP(SMALL)", "cons_unitA"] <- "10A"
ihs5[ihs5$cons_unit_oth == "LARGE  SATCHET", "cons_unitA"] <- "22C"
ihs5[ihs5$cons_unit_oth == "MEDIAM SACHET", "cons_unitA"] <- "22B"
ihs5[ihs5$cons_unit_oth == "SACHET  LARGE", "cons_unitA"] <- "22C"
ihs5[ihs5$cons_unit_oth == "SMALL PACKAGE", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL POCKET", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL SARCHET", "cons_unitA"] <- "22A"
ihs5[ihs5$cons_unit_oth == "TINA (HEAPED)", "cons_unitA"] <- "25B"
ihs5[ihs5$cons_unit_oth == "TUB", "cons_unitA"] <- "22"
ihs5[ihs5$cons_unit_oth == "TBE", "cons_unitA"] <- "22"
ihs5[ihs5$cons_unit_oth == "SA HETS", "cons_unitA"] <- "22"
ihs5[ihs5$cons_unit_oth == "BIG PACKET", "cons_unitA"] <- "55"
ihs5[ihs5$cons_unit_oth == "SMALL PACKET GOLD TEA", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL TABLE SALT PACKETS", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "HEAP (MEDIUM)", "cons_unitA"] <- "10B"



#Cleaning unknown units labeled as 'Other' with proxy units 
ihs5[ihs5$cons_unit_oth == "HALF LOAF", "cons_unitA"] <- "31"
ihs5[ihs5$cons_unit_oth == "MEDIUM TINS", "cons_unitA"] <- "72"
ihs5[ihs5$cons_unit_oth == "PACKET MEDIUM", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "125G PACKET", "cons_unitA"] <- "34"
ihs5[ihs5$cons_unit_oth == "149G TIN", "cons_unitA"] <- "71"
ihs5[ihs5$cons_unit_oth == "PACKET (MEDIUM)", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "20 LITRE PAIL", "cons_unitA"] <- "4C"
ihs5[ihs5$cons_unit_oth == "MEDIUM PACKET", "cons_unitA"] <- "54"
ihs5[ihs5$cons_unit_oth == "10G PACKET", "cons_unitA"] <- "70"
ihs5[ihs5$cons_unit_oth == "135G PACKET", "cons_unitA"] <- "34"
ihs5[ihs5$cons_unit_oth == "20G", "cons_unitA"] <- "41"
ihs5[ihs5$cons_unit_oth == "80G PACKET", "cons_unitA"] <- "34"
ihs5[ihs5$cons_unit_oth == "PACKET (300G)", "cons_unitA"] <- "65"
ihs5[ihs5$cons_unit_oth == "PACKET OF 125 GRAMS", "cons_unitA"] <- "34"
ihs5[ihs5$cons_unit_oth == "HALF PAIL", "cons_unitA"] <- "4B"

```

```{r}

#Cleaning top 15 known units labeled as 'Other'
ihs5[ihs5$cons_unit_oth == "PACKET", "cons_unit"] <- "60"
ihs5[ihs5$cons_unit_oth == "SATCHET", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "BASIN", "cons_unit"] <- "27"
ihs5[ihs5$cons_unit_oth == "PACKET UNSPECIFIED", "cons_unit"] <- "51"
ihs5[ihs5$cons_unit_oth == "PLATE", "cons_unit"] <- "6"
ihs5[ihs5$cons_unit_oth == "TINA", "cons_unit"] <- "25"
ihs5[ihs5$cons_unit_oth == "GRAMS", "cons_unit"] <- "18"
ihs5[ihs5$cons_unit_oth == "PACKET (SMALL)", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "PIECE", "cons_unit"] <- "9"
ihs5[ihs5$cons_unit_oth == "BUNCH", "cons_unit"] <- "8"
ihs5[ihs5$cons_unit_oth == "MILLILITRE", "cons_unit"] <- "19"
ihs5[ihs5$cons_unit_oth == "PAIL (SMALL)", "cons_unit"] <- "4"
ihs5[ihs5$cons_unit_oth == "5L BUCKET", "cons_unit"] <- "26"
ihs5[ihs5$cons_unit_oth == "HEAP", "cons_unit"] <- "10"
ihs5[ihs5$cons_unit_oth == "BOTTLE (SMALL)" & ihs5$item_code == "803", "cons_unit"] <- "15"

#Cleaning other known units labeled as 'Other'
ihs5[ihs5$cons_unit_oth == "BATCHES", "cons_unit"] <- "8"
ihs5[ihs5$cons_unit_oth == "BUNDLE", "cons_unit"] <- "8"
ihs5[ihs5$cons_unit_oth == "TABLE SPOON", "cons_unit"] <- "59"
ihs5[ihs5$cons_unit_oth == "PAIL", "cons_unit"] <- "4"
ihs5[ihs5$cons_unit_oth == "KILOGRAM", "cons_unit"] <- "1"
ihs5[ihs5$cons_unit_oth == "PAIL (LARGE)", "cons_unit"] <- "4"
ihs5[ihs5$cons_unit_oth == "SMALL PACKET", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "PAIL (MEDIUM)", "cons_unit"] <- "4"
ihs5[ihs5$cons_unit_oth == "LITRE", "cons_unit"] <- "15"
ihs5[ihs5$cons_unit_oth == "TINA FLAT", "cons_unit"] <- "25"
ihs5[ihs5$cons_unit_oth == "MANGO", "cons_unit"] <- "9"
ihs5[ihs5$cons_unit_oth == "SATCHET (SMALL)", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "TINA HEAPED", "cons_unit"] <- "25"
ihs5[ihs5$cons_unit_oth == "SMALL SACHET", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "CLUSTER", "cons_unit"] <- "44"
ihs5[ihs5$cons_unit_oth == "PACKET LARGE", "cons_unit"] <- "55"
ihs5[ihs5$cons_unit_oth == "SMALL HEAP", "cons_unit"] <- "10"
ihs5[ihs5$cons_unit_oth == "LARGE HEAP", "cons_unit"] <- "10"
ihs5[ihs5$cons_unit_oth == "SMALL TIN", "cons_unit"] <- "71"
ihs5[ihs5$cons_unit_oth == "MEDIUM SACHET", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "SMALL  PACKET", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL TINA FLAT", "cons_unit"] <- "25"
ihs5[ihs5$cons_unit_oth == "1000G PACKET", "cons_unit"] <- "37"
ihs5[ihs5$cons_unit_oth == "25 GRAM SATCHET", "cons_unit"] <- "41"
ihs5[ihs5$cons_unit_oth == "BUNCH SMALL", "cons_unit"] <- "8"
ihs5[ihs5$cons_unit_oth == "G", "cons_unit"] <- "18"
ihs5[ihs5$cons_unit_oth == "HEAP TINA", "cons_unit"] <- "25"
ihs5[ihs5$cons_unit_oth == "HEAP(SMALL)", "cons_unit"] <- "10"
ihs5[ihs5$cons_unit_oth == "LARGE  SATCHET", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "MEDIAM SACHET", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "SACHET  LARGE", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "SMALL PACKAGE", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL POCKET", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL SARCHET", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "TINA (HEAPED)", "cons_unit"] <- "25"
ihs5[ihs5$cons_unit_oth == "TUB", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "TBE", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "SA HETS", "cons_unit"] <- "22"
ihs5[ihs5$cons_unit_oth == "BIG PACKET", "cons_unit"] <- "55"
ihs5[ihs5$cons_unit_oth == "HEAP (MEDIUM)", "cons_unit"] <- "10"


#Cleaning unknown units labeled as 'Other' with proxy units 
ihs5[ihs5$cons_unit_oth == "HALF LOAF", "cons_unit"] <- "31"
ihs5[ihs5$cons_unit_oth == "MEDIUM TINS", "cons_unit"] <- "72"
ihs5[ihs5$cons_unit_oth == "PACKET MEDIUM", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "125G PACKET", "cons_unit"] <- "34"
ihs5[ihs5$cons_unit_oth == "149G TIN", "cons_unit"] <- "71"
ihs5[ihs5$cons_unit_oth == "PACKET (MEDIUM)", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "20 LITRE PAIL", "cons_unit"] <- "4"
ihs5[ihs5$cons_unit_oth == "MEDIUM PACKET", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "10G PACKET", "cons_unit"] <- "70"
ihs5[ihs5$cons_unit_oth == "135G PACKET", "cons_unit"] <- "34"
ihs5[ihs5$cons_unit_oth == "20G", "cons_unit"] <- "41"
ihs5[ihs5$cons_unit_oth == "80G PACKET", "cons_unit"] <- "34"
ihs5[ihs5$cons_unit_oth == "PACKET (300G)", "cons_unit"] <- "65"
ihs5[ihs5$cons_unit_oth == "PACKET OF 125 GRAMS", "cons_unit"] <- "34"
ihs5[ihs5$cons_unit_oth == "SMALL PACKET GOLD TEA", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "SMALL TABLE SALT PACKETS", "cons_unit"] <- "54"
ihs5[ihs5$cons_unit_oth == "HALF PAIL", "cons_unit"] <- "4"


```

>CLEANING ITEMS LABELED AS 'OTHER'

```{r}
item_other <- ihs5 %>% count(item_oth) %>% arrange(desc(n)) %>% print(n = nrow(ihs5))


```

```{r}

#Cleaning top 14 items labeled as 'Other'
ihs5$item_code[ihs5$item_oth=='SOYA'] <- 301
ihs5$item_code[ihs5$item_oth=='WILD LOQUAT'] <- 608
ihs5$item_code[ihs5$item_oth=='EGG PLANT'] <- 402
ihs5$item_code[ihs5$item_oth=='PEACHES'] <- 601
ihs5$item_code[ihs5$item_oth=='SORGHUM FLOUR'] <- 108
ihs5$item_code[ihs5$item_oth=='NKHUNGUZU'] <- 302
ihs5$item_code[ihs5$item_oth=='COW PEAS'] <- 308
ihs5$item_code[ihs5$item_oth=='FRIED MIXTURE OF MAIZE FLOUR/BANANA AND SODA'] <- 827
ihs5$item_code[ihs5$item_oth=='POWDERED JUICE'] <- 906
ihs5$item_code[ihs5$item_oth=='MUCUNA'] <- 837
ihs5$item_code[ihs5$item_oth=='IRISH POTATOES AND FLOUR'] <- 821
ihs5$item_code[ihs5$item_oth=='NKHWANI'] <- 404
ihs5$item_code[ihs5$item_oth=='CASSAVA LEAVES'] <- 404
ihs5$item_code[ihs5$item_oth=='FROZY'] <- 907


#Cleaning other items labeled as 'Other' 
ihs5$item_code[ihs5$item_oth=='GUAVAS'] <- 606
ihs5$item_code[ihs5$item_oth=='MIXTURE OF MAIZE FLOUR/BANANA/SUGAR'] <- 827
ihs5$item_code[ihs5$item_oth=='ZIBWENTE'] <- 821
ihs5$item_code[ihs5$item_oth=='ZIBHWENTE'] <- 821
ihs5$item_code[ihs5$item_oth=='ZIBWEMPWE'] <- 821
ihs5$item_code[ihs5$item_oth=='ZIGEDE'] <- 821
ihs5$item_code[ihs5$item_oth=='CHIGEGE'] <- 821
ihs5$item_code[ihs5$item_oth=='WINE'] <- 914
ihs5$item_code[ihs5$item_oth=='GROUND AND COOKED BEANS'] <- 302
ihs5$item_code[ihs5$item_oth=='KHOBWE'] <- 308
ihs5$item_code[ihs5$item_oth=='SOHGUM FLOUR (UFA)'] <- 108
ihs5$item_code[ihs5$item_oth=='NTAPASHA (CASSAVA LEAVES)'] <- 404
ihs5$item_code[ihs5$item_oth=='MKHAKA'] <- 409
ihs5$item_code[ihs5$item_oth=='NTAPASHA'] <- 404
ihs5$item_code[ihs5$item_oth=='RAPE'] <- 403
ihs5$item_code[ihs5$item_oth=='NANAZI'] <- 604
ihs5$item_code[ihs5$item_oth=='PEAGION PEAS'] <- 303
ihs5$item_code[ihs5$item_oth=='MAPIRA'] <- 108
ihs5$item_code[ihs5$item_oth=='GRASSHOPPER'] <- 511
ihs5$item_code[ihs5$item_oth=='LOCUST'] <- 511
ihs5$item_code[ihs5$item_oth=='ZIWALA'] <- 511
ihs5$item_code[ihs5$item_oth=='MPILU'] <- 403
ihs5$item_code[ihs5$item_oth=='KHUNGUZU'] <- 302
ihs5$item_code[ihs5$item_oth=='MISALE'] <- 108
ihs5$item_code[ihs5$item_oth=='KHOLOWA'] <- 404
ihs5$item_code[ihs5$item_oth=='CHISOSO'] <- 404
ihs5$item_code[ihs5$item_oth=='BONONGWE'] <- 404
ihs5$item_code[ihs5$item_oth=='KHWANYA'] <- 404
ihs5$item_code[ihs5$item_oth=='KWANYA'] <- 404
ihs5$item_code[ihs5$item_oth=='MTAMBE'] <- 404
ihs5$item_code[ihs5$item_oth=='LUNI'] <- 404
ihs5$item_code[ihs5$item_oth=='MPHONDA'] <- 410
ihs5$item_code[ihs5$item_oth=='EGGS PLANTS'] <- 402
ihs5$item_code[ihs5$item_oth=='THERERE'] <- 411
ihs5$item_code[ihs5$item_oth=='CHAMWAMBA'] <- 411
ihs5$item_code[ihs5$item_oth=='CHITAMBE'] <- 404
ihs5$item_code[ihs5$item_oth=='DORGHUM FLOUR'] <- 108
ihs5$item_code[ihs5$item_oth=='GATHERED THERERE'] <- 411
ihs5$item_code[ihs5$item_oth=='KATATA'] <- 411
ihs5$item_code[ihs5$item_oth=='MABILINGANO'] <- 402
ihs5$item_code[ihs5$item_oth=='PUMPKINS'] <- 410
ihs5$item_code[ihs5$item_oth=='THERERE WACHINYOLOMONYA'] <- 411
ihs5$item_code[ihs5$item_oth=='THERERE WAMASAMBA'] <- 411
ihs5$item_code[ihs5$item_oth=='WILD THERERE'] <- 411
ihs5$item_code[ihs5$item_oth=='DUCK'] <- 509
ihs5$item_code[ihs5$item_oth=='ANTELOPE'] <- 505
ihs5$item_code[ihs5$item_oth=='BIRD'] <- 509
ihs5$item_code[ihs5$item_oth=='TSETSENYA (LOOKS LIKE IMSECTS'] <- 511
ihs5$item_code[ihs5$item_oth=='CHIBUKU BEER'] <- 908
ihs5$item_code[ihs5$item_oth=='FIRST CHOICE MILK'] <- 701
ihs5$item_code[ihs5$item_oth=='SODA'] <- 812
ihs5$item_code[ihs5$item_oth=='ROYCO'] <- 811
ihs5$item_code[ihs5$item_oth=='MIXED BEANS'] <- 302
ihs5$item_code[ihs5$item_oth=='BUTTER BEANS'] <- 301
ihs5$item_code[ihs5$item_oth=='RED BEANS'] <- 302
ihs5$item_code[ihs5$item_oth=='YELLOW BEANS'] <- 302
ihs5$item_code[ihs5$item_oth=='ROASTED SWEET POTATO'] <- 832
ihs5$item_code[ihs5$item_oth=='IRISH POTATOES'] <- 205
ihs5$item_code[ihs5$item_oth=='PEPPER'] <- 811
ihs5$item_code[ihs5$item_oth=='YAMS'] <- 208
ihs5$item_code[ihs5$item_oth=='COCOYAMS'] <- 208
ihs5$item_code[ihs5$item_oth=='COOKED SWEET POTATOES (VENDORS)'] <- 831
ihs5$item_code[ihs5$item_oth=='NKHWALI'] <- 509
ihs5$item_code[ihs5$item_oth=='BAKES'] <- 906
ihs5$item_code[ihs5$item_oth=='BAKES JUICE'] <- 906
ihs5$item_code[ihs5$item_oth=='DRAGON  FROZY'] <- 907
ihs5$item_code[ihs5$item_oth=='JOLKY JUS'] <- 906
ihs5$item_code[ihs5$item_oth=='JOLLY JAS JUICE'] <- 906
ihs5$item_code[ihs5$item_oth=='THUMPS UP'] <- 907
ihs5$item_code[ihs5$item_oth=='WAKA JUICE'] <- 906
ihs5$item_code[ihs5$item_oth=='MEXICAN APPLE'] <- 609
ihs5$item_code[ihs5$item_oth=='CUSTARD APPLE'] <- 609
ihs5$item_code[ihs5$item_oth=='LEMON'] <- 603
ihs5$item_code[ihs5$item_oth=='WILD FRUIT'] <- 608
ihs5$item_code[ihs5$item_oth=='MAXICAN APPLE'] <- 609
ihs5$item_code[ihs5$item_oth=='WILD PASSION FRUIT'] <- 608
ihs5$item_code[ihs5$item_oth=='MEAN APPLE'] <- 609
ihs5$item_code[ihs5$item_oth=='CUCUMBER'] <- 409
ihs5$item_code[ihs5$item_oth=='MTAMBE'] <- 404
ihs5$item_code[ihs5$item_oth=='PINEAPPLE'] <- 604

```

>MERGE IN CONVERSION FACTORS AND HOUSEHOLD GEOVARIABLES

```{r}
#Merge in household geovariables 
ihs5 %>% left_join(., hhfilt, by = c("id" = "case_id"))
ihs5 <- ihs5 %>% left_join(., hhfilt, by = c("id" = "case_id"))

#Merge in conversion factors
convf$item_code <- as.factor(convf$item_code)
convf$region <- as.factor(convf$region)
convf$unit_code <- as.factor(convf$unit_code)
ihs5$region <- as.factor(ihs5$region)

ihs5 %>% 
    left_join(., convf, by=c("region" = "region",
                             "item_code" = "item_code", 
                             "cons_unitA" = "unit_code"))

ihs5 <- ihs5 %>% 
    left_join(., convf, by=c("region" = "region",
                            "item_code" = "item_code", 
                            "cons_unitA" = "unit_code"))

ihs5 <- ihs5 %>% rename(item_name_factor = 'item_name')


ihs5 <- ihs5 %>% select(id,hh_a02a:hh_a06, HHID.x:consYN, item_code, item_name_original, item_name_factor, item_oth:cons_unitA, cons_unit, unit_name, Otherunit, cons_unit_oth:gift_unit_size, factor, region:hh_wgt, hh_g09:hhsize)

```

>CREATE DATA FRAME OF FOOD ITEMS ONLY CONSUMED BY HOUSEHOLD 

there are 57 observations missing 
```{r}

consed <- ihs5 %>% filter(cons_quant != 0) %>% arrange(id)

#Creating a unique id variable of fcode, ucode and rcode
consed$measure_id <- paste0(as.character(consed$item_code), "_",as.character(consed$cons_unitA), "_", as.character(consed$region))


#Food unit codes in IHS5 without available factors from ihs5 conversion factor database
consed %>% filter(.,is.na(factor))

```


>REPLACE IN MISSING FACTORS(NAs) WITH AVAILABLE IHS4_FACTORS


```{r}

#--- Read in the file 
ihs4factor <- read_excel ("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/ihs4factors_v5.xls")
ihs4factor <- ihs4factor %>% select(measure_id:unit, ihs4factor_n:ihs4factor_s)



#Renaming variables 
names(ihs4factor) [names(ihs4factor) == 'ihs4factor_n'] <- '1'
names(ihs4factor) [names(ihs4factor) == 'ihs4factor_c'] <- '2'
names(ihs4factor) [names(ihs4factor) == 'ihs4factor_s'] <- '3'


#Gather wide columns into a longer column by increasing the number of rows and decreasing the number of columns
ihs4factor <- pivot_longer(ihs4factor, cols=6:8, names_to= "Region_ihs4factor", values_to = "ihs4factors", values_drop_na = TRUE)


#Renaming variables
ihs4factor <- ihs4factor %>% rename(
 ihs4_fcode = 'fcode',
ihs4_item = 'item',
ihs4_ucode = 'ucode',
ihs4_unit = 'unit')

ihs4factor$ihs4_fcode <- as.factor(ihs4factor$ihs4_fcode)
 
#creating a unique id of fcode, ucode and rcode in the ihs4factor
 ihs4factor$measure_id <- paste0(as.character(ihs4factor$measure_id), "_", as.character(ihs4factor$Region_ihs4factor))
 
 #creating a data frame of missing conversion factors
 ihs5_factor_missing <- consed %>% filter(.,is.na(factor)) %>% select(id, measure_id, item_code, item_name_original, factor)
 
 ihs5_factor_missing %>% filter(.,is.na(factor)) %>% count(factor)
 


#merge in ihs5_missing factor file with the ihs4_factors
ihs5_factor_missing <- ihs5_factor_missing %>% left_join(., ihs4factor, by=c('measure_id' = 'measure_id', 'item_code' = 'ihs4_fcode'))

ihs5_factor_missing <- select(ihs5_factor_missing, -5)



#Replace missing factors with available ihs4_factors using the match function
 consed$factor[is.na(consed$factor)] <- ihs5_factor_missing$ihs4factors[match(consed$measure_id, ihs5_factor_missing$measure_id)][which(is.na(consed$factor))]

 consed %>% filter(.,is.na(factor)) %>% count(factor)
 
```

>CREATE A NEW VARIABLE OF QUANTITY IN KG 

the new variable was created by multiplying 'cons_quant' by 'factor'

```{r}

consed <- consed %>% mutate(New_quant_kg = cons_quant * factor)

 consed %>% group_by(item_name_original, cons_unitA) %>% filter(is.na(factor)) %>% count(factor) %>% arrange(desc(n))

```

>MERGE IN CLEAN IHS5- 'PURCHASES', 'PRODUCTION' & 'GIFTS'

The quantities of items that came from purchases, own-production and gifts have been cleaned separately, and we merge them into the Masterfile 'consed' 

```{r}

#--- Read in the files 

purc_consed <- read.csv ("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/ihs5_purchased_clean.csv")
prod_consed <- read.csv ("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/ihs5_produced_clean.csv")
gift_consed <- read.csv ("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/ihs5_gift_clean.csv")

#change data class of 'items' purchased of each food 
purc_consed$id <- as.character(purc_consed$id)
purc_consed$consYN <- as.factor(purc_consed$consYN)
purc_consed$item_code <- as.factor(purc_consed$item_code)
purc_consed$item_name_original <- as.factor(purc_consed$item_name_original)
purc_consed$item_oth <- as.factor(purc_consed$item_oth)
purc_consed$purc_unitA <- as.factor(purc_consed$purc_unitA)
purc_consed$purc_unit <- as.factor(purc_consed$purc_unit)
purc_consed$purc_unit_oth <- as.factor(purc_consed$purc_unit_oth)
purc_consed$region <- as.factor(purc_consed$region)

 purc_consed <- select(purc_consed, -1)
 
#change data class of 'items' produced of each food  
prod_consed$id <- as.character(prod_consed$id)
prod_consed$consYN <- as.factor(prod_consed$consYN)
prod_consed$item_code <- as.factor(prod_consed$item_code)
prod_consed$item_name_original <- as.factor(prod_consed$item_name_original)
prod_consed$item_oth <- as.factor(prod_consed$item_oth)
prod_consed$prod_unitA <- as.factor(prod_consed$prod_unitA)
prod_consed$prod_unit <- as.factor(prod_consed$prod_unit)
prod_consed$prod_unit_oth <- as.factor(prod_consed$prod_unit_oth)
prod_consed$region <- as.factor(prod_consed$region)

prod_consed <- select(prod_consed, -1)
 
#change data class of 'items' gifted/other sources of each food  
gift_consed$id <- as.character(gift_consed$id)
gift_consed$consYN <- as.factor(gift_consed$consYN)
gift_consed$item_code <- as.factor(gift_consed$item_code)
gift_consed$item_name_original <- as.factor(gift_consed$item_name_original)
gift_consed$item_oth <- as.factor(gift_consed$item_oth)
gift_consed$gift_unitA <- as.factor(gift_consed$gift_unitA)
gift_consed$gift_unit <- as.factor(gift_consed$gift_unit)
gift_consed$gift_unit_oth <- as.factor(gift_consed$gift_unit_oth)
gift_consed$region <- as.factor(gift_consed$region)

gift_consed <- select(gift_consed, -1)
  
```

```{r}
#merge in 'cleaned items' purchased of each food 
consed <- consed %>% 
    left_join(., purc_consed, by=c("id" = "id",
                             "HHID.x" = "HHID.x", 
                             "hh_g00_1" = "hh_g00_1",
                             "hh_g00_2" = "hh_g00_2",
                             "consYN" = "consYN",
                             "item_code" = "item_code",
                             "item_name_original" = "item_name_original",
                             "item_oth" = "item_oth",
                             "purc_quant" = "purc_quant",
                             "purc_unitA" = "purc_unitA",
                             "purc_unit" = "purc_unit",
                             "purc_unit_oth" = "purc_unit_oth",
                             "region" = "region"))


#merge in 'cleaned items' produced of each food 
consed <- consed %>% 
    left_join(., prod_consed, by=c("id" = "id",
                             "HHID.x" = "HHID.x", 
                             "hh_g00_1" = "hh_g00_1",
                             "hh_g00_2" = "hh_g00_2",
                             "consYN" = "consYN",
                             "item_code" = "item_code",
                             "item_name_original" = "item_name_original",
                             "item_oth" = "item_oth",
                             "prod_quant" = "prod_quant",
                             "prod_unitA" = "prod_unitA",
                             "prod_unit" = "prod_unit",
                             "prod_unit_oth" = "prod_unit_oth",
                             "region" = "region"))


#merge in 'cleaned items' gifted/other sources of each food 
consed <- consed %>% 
    left_join(., gift_consed, by=c("id" = "id",
                             "HHID.x" = "HHID.x", 
                             "hh_g00_1" = "hh_g00_1",
                             "hh_g00_2" = "hh_g00_2",
                             "consYN" = "consYN",
                             "item_code" = "item_code",
                             "item_name_original" = "item_name_original",
                             "item_oth" = "item_oth",
                             "gift_quant" = "gift_quant",
                             "gift_unitA" = "gift_unitA",
                             "gift_unit" = "gift_unit",
                             "gift_unit_oth" = "gift_unit_oth",
                             "region" = "region"))

#Find the indices of any duplicated rows
dup_idx <- duplicated(consed)

#Get the duplicated rows
dup_rows <- consed[dup_idx, ]

#Select and rearrange columns
consed <- consed %>% select(id,hh_a02a:hh_a06, HHID.x:consYN, interviewDate, measure_id,  item_code, item_name_original, item_name_factor, item_oth:cons_quant, factor, New_quant_kg, cons_unitA:unit_name,cons_unit, cons_unit_oth, Otherunit, cons_unit_size, hh_g03c_1, purc_unique_id, purc_item_name_factor, purc_quant, purc_factor, purc_quant_kg, purc_unitA, purc_unit_name_factor, purc_unit, purc_unit_oth, purc_Otherunit_factor, purc_unit_size:purc_price, prod_unique_id, prod_item_name_factor, prod_quant, prod_factor, prod_quant_kg, prod_unitA, prod_unit_name_factor, prod_unit, prod_unit_oth, prod_Otherunit_factor, prod_unit_size, hh_g06c_1, gift_unique_id, gift_item_name_factor, gift_quant, gift_factor, gift_quant_kg, gift_unitA, gift_unit_name_factor, gift_unit, gift_unit_oth, gift_Otherunit_factor, gift_unit_size, region:reside, hh_g09:hhsize, hh_wgt) 

```

##MERGE IN MODULE G2 & G3 TO GI('consed')


For ihs5, the data on food consumption was recorded as part of the household questionnaire (datasets starting w/ HH_). Within this questionnaire, data on food consumption is recorded in the module G (Food consumption). Within the module G, we find 3 sets of data, each one with different level of aggregation.  

Hence, we need to load the file hh_mod_g2 and hh_mod_g3 from worldbank website (https://microdata.worldbank.org/index.php/catalog/3818) to merge in to the 'consed'-hh_mod_g1. 

Dataset description:      (i)  hh_mod_g1 - household consumption at item level
                          (ii) hh_mod_g2 - Food Consumption Over Past One Week – food                                 group (aggregate)
                          (iii) hh_mod_g3 - Food Consumption Over Past One Week – age                                 group (aggregate)

```{r}
#--- Read in the files
ihs5_g2 <- haven::read_dta("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/HH_MOD_G2.dta")
ihs5_g3 <- haven::read_dta("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/HH_MOD_G3.dta")
caloric_convf <- haven::read_dta("C:/Users/Gareth Osman/OneDrive - LUANAR/Documents/MAPS Project/ihs5 Cleaning/caloric_conversionfactor.dta")

#Extract values & labels of 'hh_g10a'
ihs5_g3 %>% distinct(hh_g10a)

ihs5_g3_attr <- stack(attr(ihs5_g3$hh_g10a, 'labels'))

#Changing variable class
ihs5_g3_attr$values <- as.factor(ihs5_g3_attr$values)
ihs5_g3$hh_g10a <- as.factor(ihs5_g3$hh_g10a)

#Merging the values and labels back into the ihs5_g3 dataset
ihs5_g3 <- ihs5_g3 %>% left_join(., ihs5_g3_attr, by=c("hh_g10a" = "values"))

ihs5_g3 <- ihs5_g3 %>% relocate("ind", .after = hh_g10a)
ihs5_g3 <- ihs5_g3 %>% rename(Age_category = 'ind')


consed <- consed %>% left_join(., ihs5_g2, by=c("id" = "case_id", "HHID.x" = "HHID"))
consed <- consed %>% left_join(., ihs5_g3, by=c("id" = "case_id", "HHID.x" = "HHID"))

#Find the indices of any duplicated rows
dup_idx2 <- duplicated(consed)

#Get the duplicated rows
dup_rows2 <- consed[dup_idx2, ]

anyDuplicated(consed, by=c("id", "item_name_original"))

#merge in caloric conversion factors 
caloric_convf <- caloric_convf %>% rename(caloric_item_name = 'item_name')
caloric_convf$item_code <- as.factor(caloric_convf$item_code)

consed <- consed %>% left_join(., caloric_convf, by= 'item_code')


```


